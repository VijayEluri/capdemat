{{toc}}

h1. Introduction

La plate-forme CapDémat est utilisée pour la dématérialisation des actes administratifs. C'est une plateforme en GPL s'appuyant sur Linux, Tomcat, Postgresql, OpenLdap.

Le serveur est installé en DMZ, il s'appelle "vmdemat", le serveur d'authentification est dans le LAN avec le nom vmcastest.

h2. URLs

Cependant l'accès en https à ces serveurs doit être fait avec les urls suivantes :
* Connexion backoffice agent :
** https://demarches[test].mairie-saint-ouen.fr/backoffice/home
* Connexion usager 
** https://demarches[test].mairie-saint-ouen.fr
* Le SSO est fait avec le serveur cas en https : 
** https://cas[test].mairie-saint-ouen.fr/cas/login

h2. Pré-requis ville

* Certificat SSL *.mairie-saint-ouen.fr (clé privée et certificat)
* Accès à Git depuis la machine cible
* Configuration de la clé SSH de l'utilisateur root de la machine cible sur code.zenexity.fr

h1. Installation de la plate-forme en typologie de production

Sauf mention contraire, toutes les commandes données dans la suite de la documentation d'installation sont à exécuter en tant que l'utilisateur root.

h1. Installation et configuration des serveurs

h2. Introduction

La machine virtuelle est installée sur le serveur de VM "srvvm10". L'OS a été installé à partir d'un [[Master debian 6 "Squeeze"]].

h2. Général

* Configurer les serveurs de telle sorte que l'encodage des caractères soit en UTF-8.
* Créer un utilisateur système capdemat :

bq. adduser capdemat

h2. Partitionnement

La partition qui doit être la plus importante est /var à cause des logs de Tomcat et d'Apache

Pour information, la base la plus volumineuse fait 800 Mo compressée. 

h2. Ports utilisés

Récapitulatif des ports utilisés par l'application et ses modules (cf Architecture physique) :

* Apache : 80 et 443
* Base de données : 5432
* Tomcat (console d'administration) : 8005
* CapDémat : 8080 (connecteur standard)

h1. Variables d'environnement

* Positionner la variable d'environnement CAPDEMAT_HOME :

bq. export CAPDEMAT_HOME='/usr/share/tomcat6/capdemat/admin'

* Positionner la variable d'environnement TOMCAT_HOME :

bq. export TOMCAT_HOME='/var/lib/tomcat6'

* Positionner la variable d'environnement ASSETS_HOME :

bq. export ASSETS_HOME='/usr/share/tomcat6/capdemat/assets'

h1. Installation et configuration des composants systèmes

CapDémat nécessite l'installation des services suivants :
* PostgreSQL 8.4
* Tomcat 6.0.x
* Java 1.6
* Apache 2.2.x

Note : l'installation et la configuration minimale des services listés ci-dessus n'est pas traitée dans le présent document. 

h2. Installation et configuration du frontal Web

h3. Installation et configuration sur Ubuntu

h4. Installation et configuration d'Apache

Installer Apache :

bq. apt-get install apache2

Si vous n'allez utiliser ce serveur que pour servir CapDémat, désactivez tous les modules et enlevez tous les sites inutiles :

bq. cd  /etc/apache2/mods-enabled/
rm auth*
rm cgid*
rm status*
cd ../sites-enabled
rm *
cd ../sites-avaible
rm *

Activez les modules nécessaires

bq. cd /etc/apache2/mods-avaible/
a2enmod proxy
a2enmod proxy_http
a2enmod ssl
a2enmod authz_host
a2enmod headers
a2enmod rewrite

Dans le fichier /etc/apache2/ports.conf, vérifier qu'Apache écoute bien sur le port 80 et, donc, contient la ligne suivante :

<pre>
NameVirtualHost *:80
Listen 80
</pre>

h4. Configuration SSL

Dans le fichier /etc/apache2/ports.conf, rajouter, si elle n'existe pas, une ligne pour que Apache écoute sur le port 443 :

<pre>
Listen 443
</pre>

h4. Redémarrage d'Apache

Redémarrer le serveur Apache pour qu'il prenne en compte la nouvelle configuration :

bq. /etc/init.d/apache2 restart

h2. Installation et configuration de la base de données

Installer les paquets PostgreSQL 8.4 (la version fournie sur debian 6 est la 8.4) :

bq. apt-get install postgresql

h3. Configuration

Les fichiers de configuration à éditer dans cette section sont dans _/etc/postgresql/8.4/main_.

Éditer le fichier pg_hba.conf, commenter les lignes existantes et :

* Ajouter une ligne pour permettre le passage des scripts de mise à jour de la base en ligne de commande :

<pre>
# TYPE  DATABASE    USER        CIDR-ADDRESS          METHOD
local   all         capdemat                                 md5
</pre>

* Si le serveur d'applications et la base de données sont sur la même machine, ajouter à la fin du fichier :

<pre>
local   all         postgres                                 ident
host    all         capdemat       127.0.0.1/32              md5
</pre>

* Si le serveur d'applications et la base de données sont sur deux machines différentes, ajouter à la fin du fichier :

<pre>
local   all         postgres                                 ident
host    all         capdemat       <code><ip_serveur_appli></code>/64     md5
</pre>

Enfin rajouter le support du langage plpgsql :

bq. su - postgres -c "createlang plpgsql template1"

Redémarrer le serveur pour qu'il prenne en compte les modifications :

bq. service postgresql restart

Créer l'utilisateur capdemat (au sens BD du terme) :

bq. su - postgres -c "createuser -P capdemat"
Enter password for new role: ******
Enter it again: ******
Shall the new role be a superuser? (y/n) n
Shall the new user be allowed to create databases? (y/n) y
Shall the new user be allowed to create more new users? (y/n) n

h2. Installation de Java 6

*Attention*

Bien vérifier que le jdk utilisé par le serveur d'applications est bien celui de Sun. Si ce n'est pas le cas vous pourriez rencontrer des problèmes avec la gestion du captcha.

h3. Installation avec les paquets Java6

* Installation de Sun java 6 (il faut activer le canal "non-free" dans _/etc/apt/sources.list_) :

bq. apt-get install sun-java6-bin sun-java6-jre sun-java6-fonts

Vérifier que le JDK de Sun est bien le JDK par défaut de la machine :

bq. java -version

<pre>
java version "1.6.0_26"
Java(TM) SE Runtime Environment (build 1.6.0_26-b03)
Java HotSpot(TM) 64-Bit Server VM (build 20.1-b02, mixed mode)
</pre>

Sinon, le configurer :

bq. update-alternatives --config java

h2. Installation du serveur d'applications Tomcat6

h3. Installation avec les paquets

bq. apt-get install ttf-mscorefonts-installer tomcat6 tomcat6-common

Dans le fichier /etc/init.d/tomcat6, désactiver le gestionnaire de sécurité de Tomcat en modifiant la variable TOMCAT6_SECURITY :

<pre>
TOMCAT6_SECURITY=no
</pre>

h3. Configuration générale

Ajouter les paramètres suivants à la variable JAVA_OPTS dans le fichier /etc/default/tomcat6 :

<pre>
-Djava.awt.headless=true -Xms1024m -Xmx2048m -XX:MaxPermSize=1024m -XX:+UseConcMarkSweepGC
</pre>

h3. Configuration du connecteur d'écoute

Configurer le connecteur qui va recevoir les requêtes transmises par le serveur Web (cf attribut protocol qui doit être HTTP/1.1) :

<pre>
<Connector port="8080" protocol="HTTP/1.1" connectionTimeout="20000" URIEncoding="UTF-8" useBodyEncodingForURI="true" />
</pre>

h3. Installation de shared-mime-info

Afin d'éviter "les stacktraces non pertinentes":http://capdemat.capwebct.fr/ticket/661 de la librairie OpendesktopMimeDetector, installer le paquet shared-mime-info :

bq. apt-get install shared-mime-info

h1. Installation et configuration de CapDémat

h2. Livrables

L'application est composée de trois livrables :

* CapDemat-%version%-%date%.war : application Web comprenant le Back Office et le Front Office
* CapDemat-admin-%version%-%date%.zip : package d'administration (utilitaires d'initialisation, de migration, d'administration et d'exploitation)
* Assets (données spécifiques de la ville) : versionnées dans le dépôt Git du projet

Les deux premiers sont disponibles dans "la forge dédiée à la ville de Saint Ouen":https://code.zenexity.com/projects/saintouen/files.

h2. Installation des webapps de CapDémat

L'application Web tourne sur un serveur d'applications Tomcat 6.0.x. Vous devez donc avoir au préalable installé et configuré Tomcat6. Dans la suite de l'installation, on appellera $TOMCAT_HOME le répertoire d'installation de Tomcat.

Supprimer l'application ROOT par défaut :

bq. rm -rf $TOMCAT_HOME/webapps/ROOT/*

Dé-zipper l'archive .war dans son répertoire :

bq. unzip <notextile>-d</notextile> $TOMCAT_HOME/webapps/ROOT CapDemat-%version%-%date%.war

h2. Installation du package d'administration

Créer le répertoire $CAPDEMAT_HOME s'il n'existe pas :

bq. mkdir -p $CAPDEMAT_HOME

Dé-zipper le package et mettre les bons droits sur le nouveau répertoire :

bq. unzip <notextile>-d</notextile> $CAPDEMAT_HOME CapDemat-admin-%version%-%date%.zip
chown -R tomcat6:tomcat6 $CAPDEMAT_HOME

h2. Installation des assets

h3. Ajout du mapping sur le frontal Web

Créer un fichier _/etc/apache2/sites-available/saintouen-ssl_ et ajouter la section suivante :

<pre>
<VirtualHost *:443>
  ServerAdmin sysadm@mairie-saint-ouen.fr
  ServerName demarches.mairie-saint-ouen.fr
  SSLEngine on
  SSLCertificateFile /etc/ssl/vhosts/capdemat/server.crt
  SSLCertificateKeyFile /etc/ssl/vhosts/capdemat/server.key
  DocumentRoot /var/www
  <Directory />
    Options Indexes FollowSymLinks MultiViews
    AllowOverride None
    Order allow,deny
    allow from all
  </Directory>
  ErrorLog /var/log/apache2/error-capdemat_ssl.log
  LogLevel warn
  CustomLog /var/log/apache2/access_ssl-capdemat.log combined
  RewriteEngine On
  RewriteRule ^/$ https://%{SERVER_NAME}/frontoffice/home [NE]
  ProxyRequests Off
  <Proxy *>
    Order deny,allow
    Allow from all
  </Proxy>
  #CapDemat
  ProxyPass / http://127.0.0.1:8080/
  ProxyPassReverse / http://127.0.0.1:8080/
  RequestHeader set X-Forwarded-Proto https
  ProxyPreserveHost on
</VirtualHost>
</pre>

Copier le certificat et sa clé privée :

bq. mkdir -p /etc/ssl/vhosts/capdemat
cp *.mairie-saint-ouen.fr.key /etc/ssl/vhosts/capdemat/server.key
cp *.mairie-saint-ouen.fr.crt /etc/ssl/vhosts/capdemat/server.crt

Créer un fichier _/etc/apache2/sites-available/saintouen_ et ajouter la section suivante :

<pre>
<VirtualHost *:80>
  ServerAdmin sysadm@mairie-saint-ouen.fr
  ServerName demarches.mairie-saint-ouen.fr
  DocumentRoot /var/www
  ErrorLog /var/log/apache2/error-capdemat.log
  LogLevel warn
  CustomLog /var/log/apache2/access-capdemat.log combined
  ProxyRequests Off
  <Proxy *>
    Order deny,allow
    Allow from all
  </Proxy>
  #redirect match
  RewriteEngine On
  RewriteLog /var/log/apache2/rewrite_log-capdemat
  RewriteLogLevel 1
  RewriteRule ^/$ https://%{SERVER_NAME}/frontoffice/home [NE]
  RewriteRule ^/(.*) https://%{SERVER_NAME}/$1 [NE]
</VirtualHost>
</pre>

Activer les deux nouveaux hôtes :

bq. a2ensite saintouen
a2ensite saintouen-ssl

Redémarrer le serveur Web pour que les modifications soient prises en compte :

bq. /etc/init.d/apache2 reload

h3. Création et initialisation de la base de données

bq. createdb -U capdemat -O capdemat capdemat_saintouen
psql -U capdemat -W -f $CAPDEMAT_HOME/db/create_schema_pgsql.sql capdemat_saintouen

*Ne pas oublier la mise en place des sauvegardes automatiques*

h3. Installation de l'asset et déclaration CAS

Pour pouvoir récupérer les assets, il faut au préalable ajouter la clé SSH de l'utilisateur root sur code.zenexity.com.

Installer l'asset :

bq. mkdir -p $ASSETS_HOME
cd $ASSETS_HOME
git clone git@code.zenexity.com:capdemat/capdemat-clients/saintouen.git

Vérifier le contenu du fichier _$ASSETS_HOME/saintouen/localAuthority-saintouen.xml_. En particulier :
* La propriété defaultServerName (demarches.mairie-saint-ouen.fr)
* Le mot de passe de l'utilisateur capdemat pour se connecter à la BD
* Les URLs de connexion aux différentes applications métiers (Technocarte, Mélodie, Civil Net Élections)

Copier le fichier de propriétés de l'application dans la webapp de CapDémat :

bq. cp $ASSETS_HOME/deployment/production.properties $TOMCAT_HOME/webapps/ROOT/WEB-INF/classes/CapDemat-config.properties

Donner les droits à l'utilisateur tomcat6 sur le répertoire des assets :

bq. chown -R tomcat6:tomcat6 $ASSETS_HOME

h2. Test

Démarrer Tomcat :

bq. /etc/init.d/tomcat6 start

La première vérification est de regarder les logs de Tomcat (voir la documentation d'exploitation) pour s'assurer que l'application a correctement démarré. Si aucune erreur apparaît, tester le bon fonctionnement en vous connectant à "la page d'accueil du Front Office":http://demarches.mairie-saint-ouen.fr/frontoffice/home/login 
